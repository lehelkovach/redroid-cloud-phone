#!/bin/bash
# VNC startup script - launches XFCE desktop with Weston (Wayland) for Waydroid

# Set environment
export XDG_SESSION_TYPE=x11
export XDG_RUNTIME_DIR=/run/user/$(id -u)
export DISPLAY=:1

# Create runtime dir if needed
mkdir -p "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"

# Start dbus session
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval $(dbus-launch --sh-syntax)
    export DBUS_SESSION_BUS_ADDRESS
fi

# Start Weston (Wayland compositor) on X11 for Waydroid
# Weston will run on wayland-0, which Waydroid needs
export WAYLAND_DISPLAY=wayland-0
weston --backend=x11-backend.so --xwayland &
WESTON_PID=$!
sleep 2

# Set environment for Waydroid
export WAYLAND_DISPLAY=wayland-0
export XDG_RUNTIME_DIR=/run/user/$(id -u)

# Start Waydroid session in background
waydroid session start &
WAYDROID_PID=$!
sleep 3

# Start XFCE on top
exec startxfce4
