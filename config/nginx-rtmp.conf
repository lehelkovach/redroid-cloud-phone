# nginx configuration with RTMP module
# For OBS â†’ Virtual Camera/Mic pipeline

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

# RTMP server for OBS ingest
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        # Main stream application
        # OBS streams to: rtmp://YOUR_IP/live/cam
        application live {
            live on;
            record off;
            
            # Allow publishing from any source
            allow publish all;
            
            # Internal playback only
            allow play 127.0.0.1;
            deny play all;
            
            # Low latency settings
            interleave on;
            wait_key on;
            wait_video on;
            
            # Drop slow clients
            drop_idle_publisher 30s;
        }
    }
}

# HTTP server for stats/health
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    access_log /var/log/nginx/access.log;
    
    server {
        listen 127.0.0.1:8081;
        
        # RTMP statistics
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        
        # Health check
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
        
        # Check if stream is active
        location /stream-status {
            rtmp_stat all;
            add_header Content-Type application/json;
        }
    }
}
